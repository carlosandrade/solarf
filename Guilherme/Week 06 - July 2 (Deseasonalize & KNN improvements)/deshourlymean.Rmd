---
title: "deshourlymean"
author: "Guilherme Nobre"
date: "Wednesday, June 17, 2015"
output: html_document
---
This is for the training data (2013):
```{r}
clean = function(data)
{
  data$MEAN = NA #create new column for the mean value
  data$DES = NA #create new column for the deseasonalized value
  data$st1 = NA #create new column for S(t - 1)
  data$st2 = NA #create new column for S(t - 2)
  data = data[c("MON", "DAY", "YEAR", "HR", "SOLR", "MEAN", "DES", "st1", "st2")] #necessary columns for prediction
  rownames(data) = NULL #remove row names from data frame
  data
}

n = 1 #1-MEAN
      #2-MAX
      #3-MIN

data = readRDS("SCBH1.rds") #get the csv data
train = list() #create a list of data frames
train[[1]] = data[(data$YEAR == 2013),] #get the 2013 data
train[[2]] = data[(data$YEAR == 2012),] #get the 2013 data
train[[3]] = data[(data$YEAR == 2008),] #get the 2013 data

train[[1]] = clean(train[[1]])
train[[2]] = clean(train[[2]])
train[[3]] = clean(train[[3]])


test = data[(data$YEAR == 2014),]
test = clean(test)

#test = test[(test$HR >= 6 & test$HR <= 17),]

cont = 0;
#  for loop to generate the mean hourly #
for (i in 1:nrow(test)) #goes through all the rows of the test data frame
{
  #get the respective row from each data set
  data2013 = train[[1]][(train[[1]]$MON == test$MON[i] & train[[1]]$DAY == test$DAY[i] & train[[1]]$HR == test$HR[i]),] 
  data2012 = train[[2]][(train[[2]]$MON == test$MON[i] & train[[2]]$DAY == test$DAY[i] & train[[2]]$HR == test$HR[i]),] 
  data2008 = train[[3]][(train[[3]]$MON == test$MON[i] & train[[3]]$DAY == test$DAY[i] & train[[3]]$HR == test$HR[i]),] 
  
  if (nrow(data2013) > 0 & nrow(data2012) > 0 & nrow(data2008) > 0 )
    {
    if (n == 1) test$MEAN[i] = mean(c(data2013$SOLR, data2012$SOLR, data2008$SOLR), na.rm = TRUE)
    if (n == 2) test$MEAN[i] = max(data2013$SOLR, data2012$SOLR, data2008$SOLR, na.rm = TRUE)
    if (n == 3) test$MEAN[i] = min(data2013$SOLR, data2012$SOLR, data2008$SOLR, na.rm = TRUE)
  } 
  else 
  {
    cont = cont + 1
    test$MEAN[i] = NA
  }
  
}

# for loop to put the mean value into the train data frame #
for (x in 1:length(train))
  {
    for (i in 1:nrow(train[[x]])) 
    {
      data2013 = test[(test$MON == train[[x]]$MON[i] & test$DAY == train[[x]]$DAY[i] & test$HR ==train[[x]]$HR[i]),]
      if (nrow(data2013) > 0) train[[x]]$MEAN[i] = data2013$MEAN 
    }
  }

# for loop to get the deseasonalized value (solar radiance - mean) # TEST
for (i in 1:nrow(test)) 
{
  test$DES[i] = test$SOLR[i] - test$MEAN[i]
}

# for loop to get the deseasonalized value (solar radiance - mean) # TRAIN
for (x in 1:length(train)) 
  {
    for (i in 1:nrow(train[[x]])) 
    {
      train[[x]]$DES[i] = train[[x]]$SOLR[i] - train[[x]]$MEAN[i]
    }
  }

# for loop to get s(t-1) and s(t-2) #train data
for (x in 1:length(train))
  {
    for (i in 2:nrow(train[[x]])) 
    {
      train[[x]]$st1[i] = train[[x]]$DES[i-1] #get the hour before deseasonalized solar irradiance
    }
    
    for (i in 3:nrow(train[[x]])) 
    {
      train[[x]]$st2[i] = train[[x]]$DES[i-2] #get the two hour before deseasonalized solar irradiance
    }
  }

# for loop to get s(t-1) and s(t-2) # test data
for (i in 2:nrow(test)) 
{
  test$st1[i] = test$DES[i-1] #get the hour before solar irradiance
}

for (i in 3:nrow(test)) 
{
  test$st2[i] = test$DES[i-2] #get the two hour before solar irradiance
}

data = rbind(train[[1]], train[[2]], train[[3]]) #put the two data frames together
model = lm(DES ~ st1 + st2, data = data) #builds the model using the deseasonalized value as the dependent variable. S(t-1) and S(t-2) as the independent variable.

test$DESpred = predict(model, test) #get the predctions for the deseasonalized value
for (i in 1:nrow(test)) 
{
  test$pred = test$DESpred + test$MEAN #sums the deseasonalized value with the mean value to get the real prediction
}
test = test[(test$HR >= 8 & test$HR <= 17),]
deshourlymean = test
deshourlymean$error = abs(deshourlymean$SOLR - deshourlymean$pred)
mean(deshourlymean$error, na.rm = TRUE)
hist(deshourlymean$error, main="Deseasanoliaisdjsid", xlab="Error")
boxplot(error~HR,data=deshourlymean, main="deseazds", 
        xlab="Hour", ylab="Error", ylim=c(0, 900))

test = test[c("YEAR", "MON", "DAY", "HR", "pred")] #creates a new data frame in the needed format
colnames(test)[5] <- "SOLR" #change the name of the predictions column to SOLR
 #from 8am to 5pm
write.csv(test, file = "deshourlymean.csv",row.names=FALSE) #generate the csv file
```

The script outputs a csv file named deshourlymeanm2.csv.
