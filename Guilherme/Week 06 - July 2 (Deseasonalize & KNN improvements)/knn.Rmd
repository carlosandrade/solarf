---
title: "knn regression"
author: "Guilherme Nobre"
date: "Wednesday, June 25, 2015"
output: html_document
---

First of all, we read and treat the data to look as the table below:

<img src="table2.jpg" />

This is for the training data (2013):

```{r}
#return (test[(count-1),]$SOLR + test[(count+1),]$SOLR) / 2
interpolation = function(data)
{
  count  = 1
  while (count != 0) 
  {
    count = 0
    for (i in 1:nrow(data)) 
    {
      if(is.na(data[(i),]$SOLR)) count = i
    }
    if(count == 0) break
    data[(count),]$SOLR = 0
  }
  data
}

data = readRDS("SCBH1.rds") #get the csv data
train = data[(data$YEAR == 2013),]
train.SOLR = train$SOLR
train = train[c("MON", "DAY", "YEAR", "HR", "SOLR")] #necessary columns for prediction
rownames(train) = NULL #remove row names from data frame

train$st1 = 0 #create new column for S(t - n)
train$st2 = 0 #create new column for S(t - (n+1))

train = interpolation(train)


for (i in 2:nrow(train)) 
{
  train$st1[i] = train$SOLR[i-1] #get the hour before solar irradiance
}

for (i in 3:nrow(train)) 
{
  train$st2[i] = train$SOLR[i-2] #get the two hour before solar irradiance
}

traindata = train[c("st1", "st2")]
###################################
test = data[(data$YEAR == 2014),]
test.SOLR = test$SOLR
test = test[c("MON", "DAY", "YEAR", "HR", "SOLR")] #necessary columns for prediction
rownames(test) = NULL #remove row names from data frame

test$st1 = 0 #create new column for S(t - n)
test$st2 = 0 #create new column for S(t - (n+1))

test = interpolation(test)
for (i in 2:nrow(test)) 
{
  test$st1[i] = test$SOLR[i-1] #get the hour before solar irradiance
}

for (i in 3:nrow(test)) 
{
  test$st2[i] = test$SOLR[i-2] #get the two hour before solar irradiance
}
testdata = test[c("st1", "st2")] #necessary columns for prediction

library(FNN)

test.knn <- knn.reg(traindata, test = testdata, y=train.SOLR, k=3);
test$pred = test.knn$pred
test$SOLR = test.SOLR
test = test[(test$HR >= 8 & test$HR <= 17),] #from 8am to 5pm


knn = test
knn$error = abs(knn$SOLR - knn$pred)
mean(knn$error, na.rm = TRUE)
hist(knn$error, main = "KNN", ylim=c(0, 900), xlim=c(0, 800), xlab="Error")
boxplot(error~HR,data=knn, main="KNN", 
        xlab="Hour", ylab="Error", ylim=c(0, 900))

knn = knn[c("YEAR", "MON", "DAY", "HR", "pred")]
colnames(knn)[5] <- "SOLR" #change the name of the predictions column to SOLR
write.csv(knn, file = "knn.csv",row.names=FALSE) #generate the csv file
```
