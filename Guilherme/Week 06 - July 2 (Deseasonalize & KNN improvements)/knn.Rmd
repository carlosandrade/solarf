---
title: "knn regression"
author: "Guilherme Nobre"
date: "Wednesday, June 25, 2015"
output: html_document
---

First of all, we read and treat the data to look as the table below:

<img src="table2.jpg" />

This is for the training data (2013):

```{r}
n = 1
#return (test[(count-1),]$SOLR + test[(count+1),]$SOLR) / 2
interpolation = function(data)
{
  count  = 1
  while (count != 0) 
  {
    count = 0
    for (i in 1:nrow(data)) 
    {
      if(is.na(data[(i),]$SOLR)) count = i
    }
    if(count == 0) break
    data[(count),]$SOLR = 0
  }
  data
}
clean = function(data)
{
  data$st1 = 0 #create new column for S(t - 1)
  data$st2 = 0 #create new column for S(t - 2)
  data = data[c("MON", "DAY", "YEAR", "HR", "SOLR", "st1", "st2")] #necessary columns for prediction
  rownames(data) = NULL #remove row names from data frame
  data
}
getPast = function(data, n)
{
  for (t in (n+1):nrow(data)) 
  {
    data$st1[t] = data$SOLR[t-(n)] #get the n hour before solar irradiance
  }
  
  for (t in (n+2):nrow(data)) 
  {
    data$st2[t] = data$SOLR[t-(n+1)] #get the (n + 1) hour before solar irradiance
  }
  data
}
####################################################
data = readRDS("SCBH1.rds") #get the csv data
train = data[(data$YEAR == 2013),]
train.SOLR = train$SOLR
train = clean(train)
train = interpolation(train)
train = getPast(train, n)
traindata = train[c("st1", "st2")]
###################################
test = data[(data$YEAR == 2014),]
test.SOLR = test$SOLR
test = clean(test)
test = interpolation(test)
test = getPast(test, n)
testdata = test[c("st1", "st2")] #necessary columns for prediction
####################################
library(FNN)

test.knn <- knn.reg(traindata, test = testdata, y=train.SOLR, k=3);
test$pred = test.knn$pred
test$SOLR = test.SOLR
test = test[(test$HR >= 8 & test$HR <= 17),] #from 8am to 5pm

###############################################
knn = test
knn$error = abs(knn$SOLR - knn$pred)
mean(knn$error, na.rm = TRUE)
hist(knn$error, main = "KNN", ylim=c(0, 900), xlim=c(0, 800), xlab="Error")
boxplot(error~HR,data=knn, main="KNN", 
        xlab="Hour", ylab="Error", ylim=c(0, 900))
################################################

knn = knn[c("YEAR", "MON", "DAY", "HR", "pred")]
colnames(knn)[5] <- "SOLR" #change the name of the predictions column to SOLR
write.csv(knn, file = "knn.csv",row.names=FALSE) #generate the csv file
```
